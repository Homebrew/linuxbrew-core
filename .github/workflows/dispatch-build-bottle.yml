name: Build bottles from 'brew request-bottle' trigger.

on: repository_dispatch

jobs:
  bottling:
    runs-on: ubuntu-latest
    container:
      image: homebrew/brew
    steps:
      - name: Print details
        run: |
          echo formula=${{github.event.client_payload.formula}}
          echo sender=${{github.event.sender.login}}
          echo name=${{github.event.client_payload.name}}
          echo ignore-errors=${{github.event.client_payload.ignore_errors}}
      - name: Build bottles
        run: |
          mkdir ~/bottles
          cd ~/bottles
          brew update-reset $(brew --repo ${{github.repository}})
          brew test-bot \
            --tap=homebrew/core \
            --keep-old \
            ${{github.event.client_payload.formula}}
      - name: Upload bottles
        env:
          HOMEBREW_BINTRAY_USER: LinuxbrewTestBot
          HOMEBREW_BINTRAY_KEY: ${{secrets.HOMEBREW_BINTRAY_KEY}}
        if: success() || github.event.client_payload.ignore_errors
        run: |
          cd ~/bottles
          brew update-reset $(brew --repo ${{github.repository}})
          brew test-bot \
            --tap=homebrew/core \
            --bintray-org=linuxbrew \
            --ci-upload \
            --publish \
            --keep-old \
            ${{github.event.client_payload.formula}}
      - name: Report upload failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          issue-number: 1 # TODO
          body: |
            Formula = `${{github.event.client_payload.formula}}`
            Workflow = `${{github.workflow}}`
            Run = `${{github.run_id}}`
            Event = `${{github.event_name}}`
            Actor = `${{github.actor}}`
      - name: Push bottles
        env:
          GIT_COMMITTER_NAME: ${{github.event.client_payload.name}}
          GIT_COMMITTER_EMAIL: ${{github.event.client_payload.email}}
        if: success() || github.event.client_payload.ignore_errors
        run: |
          cd $(brew --repo ${{github.repository}})
          git commit --amend --no-edit
          git show --pretty=fuller
          for try in $(seq 5); do
            git fetch
            git rebase origin/master
            if git push https://x-access-token:${{secrets.GITHUB_TOKEN}}@github.com/${{github.repository}} master; then
              break
            else
              sleep 3s
            fi
          done
      - name: Report push failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          issue-number: 1 # TODO
          body: |
            Formula = `${{github.event.client_payload.formula}}`
            Workflow = `${{github.workflow}}`
            Run = `${{github.run_id}}`
            Event = `${{github.event_name}}`
            Actor = `${{github.actor}}`
