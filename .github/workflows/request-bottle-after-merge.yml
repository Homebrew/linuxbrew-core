name: Request bottles after upstream merge.

on:
  push:
    branches:
      - master
    paths:
      - 'Formula/*'

jobs:
  request-bottles:
    if: startsWith(github.event.head_commit.message, 'Merge') == true
    runs-on: ubuntu-latest
    container:
      image: homebrew/brew
    steps:
      - name: Checkout tap
        uses: actions/checkout@v2
        with:
          fetch-depth: 100
      - name: Setup tap
        run: |
          rm -rf $(brew --repository ${{github.repository}})
          ln -s $GITHUB_WORKSPACE $(brew --repository ${{github.repository}})
      - name: Setup git
        run: |
          git config --global user.name BrewTestBot
          git config --global user.email homebrew-test-bot@lists.sfconservancy.org
      - name: Tap linux-dev
        run: brew tap homebrew/linux-dev
      - name: Run brew request-bottle
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
        run: |
          set -eu
          brew find-formulae-to-bottle | xargs -n1 brew request-bottle
